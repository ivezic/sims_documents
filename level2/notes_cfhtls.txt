Notes on Regnault, etal 2009, "Photometric Calibration of the Supernova Legacy Survey Fields"

driver on photometric precision is supernova: need to compare high redshift (z=0.7, riz bands), intermediate (z=0.4, gr bands), and nearby (z=0.05, landolt UBVRI from other surveys). 
1% shift of high-redshift zeropoints results in change in w of 0.040; 1nm precision of survey bandpass central wavelength is 0.013 uncertainty on w; 1% error in B and R intercalibration has impact of 0.024 on w. 

another driver is photometric redshift of galaxies (comparing photometry from different bandpasses). Sensitive to 1% level zeropoint changes. Also requires accurate determination of bandpass. 

goal: SNLS = calibrate supernva fluxes as close to 1% as possible. Difficulties include: 
- control of imager photometric response uniformity (flat field)
- modeling of large and non-linear Landolt-to-Megacam color transform
- choice of underlying optimal spectrophotometric standard to interpret mags as physical fluxes
- modeling of the imager effective bandpasses (measuring phi_b)

Output of calibration: grizy natural mags (not dependent on source color) + recipe to map mags to fluxes, + model of imager effective bandpasses. Photometric response map (next data release). 
u band data particularly sensitive to atmospheric conditions and to airmass, thus lower precision.

Details of megacam: 0.94x0.94 deg camera, 36 thinned E2V chips, 0.18" pix scale, F/4.1 beam. 
Seeing typically 0.65" at center, 0.9" at edges (at start of survey); after change in optics setup, now ~0.4-0.5" across entire fov.
CFHT: Equatorial mount, camera angle fixed wrt telescope and sky (no variable rotation for fields). 
Linearity better than 1% at pix level, so <0.1% for stars. 
Filters similar to, but not the same as SDSS ugriz. Transmission measured by manufacturers and CFHT upon reception; spatial non-uniformity of transmission curves (in particular, of the central wavelength) noticed (even across different manufacturers).  [** LJ note - this is a result of the manufacturing techniques, and should be expected]. 

SNLS: supernova search from 0.3<z<1.0 (so must compare against nearby UBVRI sn). 100 SNe Ia / yr. Observations every 3-4 nights in dark time, with griz colors each night. Exposures dithered to limit dead areas on observations, ~100 pix in x/RA, 500 pix in y/Dec. 
Standard calib program = 5 observations of one Landolt field at a time, beginning or end of a night (so separated from science observations by few hours). 

Processing: 

Preprocessed by Elixir - bias removal, flat field correction, photometric flat correction + defringing in i and z.  (in further SNLS processing, they don't want to go back to original images, so this will remain in place, although they show that the photometric flat correction, i.e. illumination correction, is not adequate in original Elixir processing). 

Errors / procedure for measurement of sources - 
Goal is to measure SN mags: so look for SN to field stars, field stars to secondary standards (i.e. photometric standards in CFHT fields). SN measured with PSF photometry, standards with aperture photometry.  Scale photometry apertures across field of view.  Typical aps about 14pix - 7.5 *HWHM. Aperture size (and scaling across fov) issue at 0.2% level. 
Background must also be estimated and removed. Removed using SExtractor background map. Estimate is less than 0.001 mag effect in g,r,z. In i is more like 0.005 mag at mag 21.  Add to systematic uncertainties. 
Aperture corrections different between standard and science images (e.g. longer exposures). Comparison of small/large radii between science/standards show less than 0.2% effect, and tertiary standards attempt to correct for this. 

The Flat Field - 
Elixir flat field correction - flat generated from all frames taken during dark run (rejecting outliers with bright stars / moon). Final flat ~400,000 ADU.  [** LJ - note this is NOT an illumination corrected flat field - there are still geometric effects, plus potential scattered light which should have been subtracted from individual image (perhaps pupil ghost, prop to intensity of light in each image), definitely also changes in bandpass shape].  Photometry for a single star flat fielded with  these 'cosmetic' flat fields varies by 15% / 10% from center to edge of field of view. 

Elixir also generates a 'photometric' flat which "ought" to deliver uniform photometry by multiplying cosmetic flat by maps of imager photometric response non-uniformities (i.e. they generate an illumination correction flat field called a 'photometric flat') [** LJ - the illumination correction was determined using raster scan of dense fields, more details below].  After flat-fielding with 'photometric flat', star photometry still varies by 4% peak-to-peak (generally center to edge again). 

Fringe frames generated by processing all i/z images by final 'photometric' flat, subtracting sky background, scaling fringes to same level and finding resulting fringe pattern. 

Plate scale effects (i.e. variable pixel scale effects in the flat field - smaller sky area -> flat field should be fainter .. but if you divide stars by this fainter flat field, you actually change their photometry because they do not scale by pixel area.): plate scale determined to better than 1% using dense stellar fields. Pixel scale varies by 4% (smaller at the corners than in the center).  However, cosmetic flat left 10-15% variation, so photometric variation (from cosmetic flat) is NOT plate scale variation only.  The 'photometric flat' has been generated by rastering /dithering exposures on low galactic latitude fields, generating "photometric grid" correction maps. 

SNLS processing: 
Regenerate photometric grid correction maps independently of Elixir determination (but using same data). Basically, regenerate the illumination correction. 

Two dense fields were used in raster scan.  Observed ~every semester, through variations in the light path (adding baffle, flipping L3, tweaking locations in the focal plane). 
Dither = exposure followed by 6 offsets in X and 6 in Y, on logarithmic spacing from few hundred pixels up to half a mosaic. Observations taken in single sequence, over limited airmass range -- to reduce extinction corrections [**LJ - and possible changes in atmospheric transmission curve]. 
Grid exposures processed with standard Elixir pipeline, but no photometric flat applied (cosmetic flat only). Should see 10-15% nonuniformity in photometry. 
Got about 100,000 stars measured twice or more and 600,000 flux measurements over grid sequence. 
Then determine:  m(x) - m(x0) = \delta zp(x) + \delta k(x) * color(x0) 
 .. .ie. the change in photometric zeropoint and change in color correction (bandpass) relative to the color/magnitude at x0 (the center of the chip). \delta zp encodes spatial variations of total normalization, \delta k encodes (at first order) variations in the central wavelength of the bandpass. 
To explicitly split color/zeropoint, define a color grid reference, color_ref, as well (could be the color of the science objects, could be the color of the grid stars ... just floats a constant into/out of \delta zp. seems they chose the color of the grid stars.(?))
[**LJ - see how this ties into our definition of 'natural magnitude' vs. 'standard mag' ? ] 

Then fit for \delta zp(x) and \delta k(x) * (color(x0) - color_ref). Parametrize grid maps using basis functions .. not smooth map, but allow for sharp discontinuities at CCD boundaries. These parametrized functions look like grids (with constant values within the grid) .. the grid cells were about 512x512 pix, with about 70 bright stars in each cell -- for the \delta zp(x) values. For \delta k(x) needed bigger cells (more stars), so used 1280x1536 pix cells.  
Must also fit for m(x0) for most stars, as they were not necessarily measured in the reference location. Same with the star's colors. [**LJ - and this is where it starts to look like our LSST self-cal minimization procedure]. 
To complete fit: use iterative approach. Fit without \delta k(x) * color terms first, then update colors, then refit. Find only need to iterate twice. 
Also, have approach to fitting the chi^2 for m(x0) for each star (not conjugate gradient) .. see Appendix A. 

Tested fit using simulations to look for degeneracies (since fit is slightly non-linear). [**LJ - we should be sure to include simulations in testing our final fits to selfcalib too].  Need to be sure to worry about outliers (bad pix or cosmics).  [**LJ - Should also consider adding identical dither exposure to end of raster scan as used in first exposure, to check for drifts in atmosphere throughput curve/extinction]. 
Also noticed that can get acceptable fit residuals when using wrong (no color term) model; adding color terms reduced chi^2 dramatically. Need to be sure actually hitting minimum of chi^2. 

Figure 7 shows \delta zp (x) maps. Includes plate scale variations, but also larger non-uniformities (presumably largely due to internal reflections in the corrector, which tend to add more light to center of field of view), including time-changing effect due to shiny metal shavings accumulating in camera from filter mechanism.  Effect is 0 at center of field of view, 10-15% at edges .. not entirely circular due to metal shavings. ~4% could be due to plate scale variation. 

Figure 9 shows \delta k(x) maps (\delta k(x) * (color(x0) - refcolor set by grid stars) is the actual magnitude offsets).  Also see radial pattern. Center 0, edge 0.03 - 0.04 value for k.  [**LJ - so, 3-4% for an object with a color one mag different than the reference color. Main sequence stars cover about 2-2.5 mags in color range,  so ~7-8% effect overall I'd guess.]

Estimates on statistical uncertainties to these maps: 0.001 mag in all bands for \delta zp(x). 0.002 mag in all bands for \delta k(x) maps. Resulting in errors in magnitudes < 0.002 mag for stars with g-r<1.0 and 0.003 for stars with g-r ~1.5. (uncertainty introduced by grid corrections after transforming to reference location). [**LJ -- this then is the error in the resulting *standardized* magnitude, because these corrections depend on the color of the source, as well as its location.] Uniformity correction depend on color as well as location. 

Difference between this analysis and Elixir: Elixir did not find significant color terms and solved for \delta zp(x) without any \delta k(x) terms, and did not solve for star magnitudes. This is certainly a big reason for any differences in Elixir vs. SNLS flat fielding. (since the color terms produce an effect of almost half the total photometric zeropoint variation). 


Magnitudes -- 
Paper introduces 'hat' magnitudes (these are equivalent to our "natural magnitudes") .. vary across the focal plane depending on the color of the source. If the source's color is equivalent to grid reference color, the hat magnitudes are flat across the focal plane, but this will not usually be the case.  However, what they will report are 'local natural magnitudes' .. i.e., magnitudes corrected to the grid reference color at a local place in the focal plane (so, these mags still vary across the focal plane, but are constant over small regions and since applied dithers were small, it'll work close enough). To translate measured flux into actual physical flux, however, they will need bandpasses at each location in the focal plane.  [**LJ - note that the translation from hat mags to standard mags for CFHTLS is based on whatever the grid reference color is, while for LSST the standard mags use a flat F_v value]. 

Synthetized bandpass at various locations in the focal plane based on measurements of filter transmission from the workbench + model of angular dependence + model of light incidence angle in the telescope [**LJ - note that filters in the beam can have different central wavelengths than filters measured in the lab with single normal incidence angle, due to overall shift from normal incidence + change from center to edge of beam].  Generate overall effective bandpass by combining CCD efficiency, filter, transmission of lenses/windows, mirror reflectivity, atmospheric transmission, and transmission of telluric features. Optical system measured by CFHT. QE from CEA team (average model).  Atmosphere from measurements at Mauna Kea. O2/OH from model. Filters from SAGEM. See Appendix B for details.    Synthetic magnitudes calculated using synthetic bandpasses at various points in focal plane match fairly well with zeropoint and color terms measured from grid (Fig 11), except for Stritzinger stellar library in r band (probably r-i is not a good color to be using as correction value .. **LJ notes that this is quite possible, and indeed to correct to 0.005 mag we need to use something more than a single color too). Resulting errors (from using synthetic bandpass rather than measured) assumed negligible. 

At this point, have a tertiary catalog in local natural magnitudes.  To calibrate to actual fluxes :: 

Translating to Landolt system: Landolt system is used to calibrate the SNLS survey. But Landolt in UBVRI. (use Landolt because want to compare SN to nearby SN data, which was calibrated with Landolt). Note that Landolt system has various corrections built-in, during initial data reductions. Problem with calibration to Landolt is that (a) UBVRI and ugriz are very different, and (b) there are few blue stars available for comparison so color terms are hard to model. Also z is much redder than R, so is extrapolation. Color terms modeled using synthetic bandpass and stellar models. Color relationship is nonlinear however, and not well-defined (depend on metallicity/logg of stars in Landolt). Plus Landolt stars are primarily measured in center of focal plane, so must propagate to edges using photometric grid \delta zp(x) and \delta k(x) (which again, is problematic due to nonlinear color relationships). This is fitting the overall zeropoint of the system, and one cause for error is the star-star dispersion that results from the fit really being multiparameter (not just single-color).  Determined uncertainties in zeropoints are 7mmag / 3mmag/ 4 mmag / 11 mmag in griz.   (even though had 1-2% dispersion in stars and parameters of slope measured to about 1% on average..)

Define local natural magnitudes. These vary across focal plane. Then have to bootstrap natural mags to flux : use fundamental spectrophotometric standard (star of known SED and known Megacam mags). Uncertainties enter through knowledge of Megacam bandpasses and measurement of Megacam mags. No suitable spectrophotometric standard usable as fundamental standard has suitable megacam observations (program underway). Megacam mags must be inferred from known Landolt mags (using color transforms established above). Did not choose Vega for fundamental standard (because Vega not direct base of Landolt catalog and Vega is bluer than average landolt star and average tertiary standards) as cannot reach 1% precision with Vega + Landolt stars. Use CALSPEC HST spectrophotometric standards with known Landolt mags + known SEDs (AGK +81 266, BD +17 4708, G191-B2b, Gd71, GRW 705824 + LDS 749B .. most of them very blue). Use BD + 17 4708 only, as color close to average Landolt colors. (is also base for SDSS).   [**LJ - worth noting that they did not use white dwarfs, as the white dwarfs were so blue, thus hard to extrapolate to Landolt system].   Evaluate effect of possible/likely faint binary, different metallicity than Landolt stars with similar colors, effect of surface gravity differences between Landolt/BD + 17 4708, and dust extinction. Calculated calibration offsets that result (i.e. change in megacam mags due to change in source SED away from Landolt stars of same color, using SED + synthetic bandpass).  Result is magnitudes in Megacam system for BD +17 4708 along with uncertainties/covariance matrix. 

Creating tertiary standard catalogs for each SNLS field :: allow user to propagate calibration to any SNLS exposure (so this is propagating absolute standard back to observations). Tertiary catalogs based on SNR > 10 objects, isolated non-variable stars (stars identified by star locus in m_xx / m_yy). 100-200 tertiary standards per CCD. [**LJ - note that the depths for individual CFHTLS Deep fields are similar to LSST individual images].  Flux of stars measured in each image, divided by exposure time, translated to X=1 using typical extinction coefficients and reported airmass (no second-order airmass-color correction applied, and no evidence observed that was necessary), then 'hat' mags (actual natural mags) calculated by removing Elixir uniformity map + applying SNLS zeropoint maps (no color term). Measurements for each star merged to produce average mags per night - allows for free parameter for atmospheric extinction variations (for each exposure) during the sequence. (Variations within most nights < 0.3% .. so pretty photometric).  Local natural magnitudes then calculated using night + band zeropoints, and adding the \delta k(x) color corrections for each location in the grid, + using Megacam colors for fundamental standard. Nonphotometric nights (absorption > 0.1 mag) rejected as well as stars with lightcurves.  Final dispersion in catalogs accepted as 'photometric' ~1%, with main source of dispersion being atmospheric variations.   Report (appendix) local natural magnitudes of stars, along with \delta k(x) grid coefficients at mean focal plane position of star (so that uniform magnitudes can be computed too). 

Plot r-i vs. g-r color-color plot for all four SNLS fields (using uniform/standard mags because using entire focal plane) & find compatible at 1% level. Phoenix/GAIA library shows that 4-6% variation may be observed due to systematic variations in stellar metallicity. [*LJ - presumably also dust extinction]. 
Resulting catalog a Vega-like system (rather than AB), because based on Landolt colors. 

Errors in tertiary catalog :: 
(random/statistical)
estimate all multiplicitative effects in measurement from one-exposure to another (atmospheric extinction, aperture correction variations, flat-field noise) ~ 0.002.  Other errors from background subtraction residuals + Poisson noise in source. Summarized in Fig 18.   Sources of errors - 
- photon noise, flatfield noise, readout noise
- atmospheric transparency variations between science/calibration exposures
- intrinsic zeropoint uncertainties
- the Landolt-to-Megacam color transformation uncertainties
[**LJ - this is mixing the 'normalization' and 'shape', as well as 'absolute' and 'relative' calibration steps, which is why this can be hard to relate to LSST photometric errors. Indeed, the paper states that much of the uncertainty is basically the statistical uncertainty on the difference between the tertiary standard calibrated magnitudes and the Megacam Mag of BD + 17 4708. (p26) ].
- dispersion in night-to-night measurements of stars in calibrated tertiary flux is about 0.009 mag (.002 when divide by sqrt(N_obs)) [**LJ  - aka, 'repeatability' .. but remember also, these stars are not dithered over the focal plane as much as LSST will do]. 
- intrinsic zeropoint uncertainties about 0.003 mag in gri, 0.005 in z. With large # of epochs, resulting statistical error is lower than or about 0.001 mag in all bands
- random uncertainties as function of mag for the tertiary catalogs shown in Fig 18 .. at bright end, ~0.003 mag in gri, 0.005 in z.    (dominated by atmospheric dispersion, generally.) 
- Landolt to megacam color transforms affect absolute calibration (g_x - g_BD + 17 4708, etc.) Find this to be ~0.002 gri, 0.005 in z. (this dominates overall statistical uncertainty budget, as it does not average out with number of epochs) 
(systematic)
aperture corrections, background subtraction, shutter precision, linearity, grid reference colors/grid color corrections, Landolt catalog mags, mag of BD  + 17 4708. summarized in table 12.
.. about 0.003 / 0.004 / 0.006/ 0.018 in g/ r/ i/ z .. dominated by BD + 17 4708 mags, then Landolt catalog (internal dispersion in mags).  After that, shutter precision primary source of error. Statistical error greater for all except i/z band. 

Full uncertainty budget: statistical + systematic. Full covariance matrix in appendix D. (uncertainties being uncertainty on g_* - g_ref, etc.) Involves Landolt stars and mags of BD _17 4708 (because these are used to determine the g_ref).   Uncertainties on order of 0.002-0.003 mag. Primary source seems to be measurements of g_*.

 
LJ - so, original Elixir processing of Megacam data with illumination correction resulted in errors of ~4% due to poor IC. The reason the IC was not as optimal as the SNLS version was due to neglecting color terms in the IC (most likely .. could also be slightly better data processing / solving for minimum chi^2 in SNLS, but since color terms produce 7-8% effect at edges (depending on color of stars), this seems like it would be important.). 
SNLS created better IC, and then find dispersion in night-night measurements of calibration stars improves to ~9mmag (.9%), or ~2mmag uncertainty (when include sqrt(N) observations). 
SNLS calibration ties absolute and relative calibration terms, due to using reference mags in the calibration process that depend on BD +17 4708, which has not been measured directly with this system (and thus introduces further color terms between Landolt and Megacam filters). 
This introduces errors in the zeropoints calculated for each observation, and also introduces the largest sources of systematic errors in the resulting tertiary catalogs, on the level of 3-18 mmag (.3-1.8%). 
Largest source of remaining error relevant to LSST process of calibration :: 
I would say it's the atmospheric transparency variations in the statistical uncertainty. But I'm not sure why they didn't apply the same minimization effort to these measurements as they did to the photometric grid / raster scan observations (as this seems like it should have minimized this difference). Perhaps by letting the zeropoint vary for each (entire) observation, as they did, this was 'good enough' (and then they rejected measurements which had high extinction to remove the source of the problem)? (but then why wasn't this listed as the largest source of eror?).
The second largest source of statistical error is the global color transformations, which require Landolt-to-Megacam color transformations. This would be limited by knowledge of the bandpass, as well as knowledge of the Landolt SEDs, as well as measurement of the observed Megacam magnitudes (which would be influenced by all the errors which contribute to the dispersion of the science stars as well - atmospheric variations, flat field errors, etc.). 
